# iOS 捷徑整合設計文件

## 概述

本文件詳細說明了智慧記帳 GEM 系統與 iOS 捷徑的整合設計，包括三種記帳情境的技術實現方案、API 接口設計和用戶體驗流程。

## 架構設計

### 系統架構圖

```
iOS 捷徑應用
    ↓
語音/圖片處理
    ↓
HTTP 請求 (GET/POST)
    ↓
Google Apps Script
    ↓
Gemini AI API
    ↓
Google Sheets
```

### 組件說明

1. **iOS 捷徑應用**：用戶界面和本地處理
2. **語音/圖片處理**：iOS 內建的語音識別和圖片處理
3. **HTTP 請求**：與後端 API 的通信
4. **Google Apps Script**：後端處理邏輯
5. **Gemini AI API**：智能內容解析
6. **Google Sheets**：資料存儲

## API 接口設計

### 1. 語音記帳 API

**端點：** `GET /exec?endpoint=voice&text={語音文字}`

**請求格式：**
```
GET https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec?endpoint=voice&text=我今天買了一杯咖啡花了150元
```

**回應格式：**
```json
{
  "status": "success",
  "message": "語音文字處理完成",
  "data": {
    "date": "2025-07-23",
    "amount": 150,
    "category": "餐飲",
    "description": "咖啡",
    "currency": "TWD"
  }
}
```

### 2. 收據拍照記帳 API

**端點：** `POST /exec?endpoint=image`

**請求格式：**
```json
{
  "image": "base64_encoded_image_data",
  "filename": "receipt.jpg"
}
```

**回應格式：**
```json
{
  "status": "success",
  "message": "收據處理完成",
  "data": {
    "date": "2025-07-23",
    "amount": 299,
    "category": "購物",
    "description": "超市購物",
    "currency": "TWD",
    "merchant": "全聯福利中心"
  }
}
```

### 3. 收據拍照加語音補充 API

**端點：** `POST /exec?endpoint=image`

**請求格式：**
```json
{
  "image": "base64_encoded_image_data",
  "filename": "receipt.jpg",
  "voiceNote": "這是公司聚餐的費用，需要報帳"
}
```

**回應格式：**
```json
{
  "status": "success",
  "message": "收據和語音處理完成",
  "data": {
    "date": "2025-07-23",
    "amount": 1200,
    "category": "餐飲",
    "description": "公司聚餐費用，需要報帳",
    "currency": "TWD",
    "merchant": "王品牛排",
    "note": "需要報帳"
  }
}
```

## iOS 捷徑設計

### 1. 語音記帳捷徑設計

#### 流程圖
```
開始
  ↓
顯示提示：「請說出您的交易內容」
  ↓
啟動語音識別
  ↓
獲取語音文字
  ↓
URL 編碼語音文字
  ↓
發送 GET 請求
  ↓
解析回應
  ↓
顯示結果
  ↓
結束
```

#### 關鍵步驟
1. **語音輸入**：使用「聽寫文字」動作
2. **URL 編碼**：使用「編碼 URL」動作處理中文字符
3. **HTTP 請求**：使用「取得 URL 內容」動作
4. **結果顯示**：使用「顯示通知」或「顯示結果」動作

### 2. 收據拍照記帳捷徑設計

#### 流程圖
```
開始
  ↓
顯示選項：「拍照」或「從相簿選擇」
  ↓
獲取圖片
  ↓
轉換為 Base64
  ↓
構建 JSON 請求體
  ↓
發送 POST 請求
  ↓
解析回應
  ↓
顯示結果
  ↓
結束
```

#### 關鍵步驟
1. **圖片獲取**：使用「拍照」或「從相簿選擇照片」動作
2. **Base64 編碼**：使用「編碼為 Base64」動作
3. **JSON 構建**：使用「取得字典的值」動作
4. **HTTP 請求**：使用「取得 URL 內容」動作，設定 POST 方法

### 3. 收據拍照加語音補充捷徑設計

#### 流程圖
```
開始
  ↓
顯示選項：「拍照」或「從相簿選擇」
  ↓
獲取圖片
  ↓
顯示提示：「請說出補充說明」
  ↓
啟動語音識別
  ↓
獲取語音文字
  ↓
轉換圖片為 Base64
  ↓
構建包含圖片和語音的 JSON
  ↓
發送 POST 請求
  ↓
解析回應
  ↓
顯示結果
  ↓
結束
```

#### 關鍵步驟
1. **圖片處理**：同收據拍照捷徑
2. **語音處理**：同語音記帳捷徑
3. **資料組合**：將圖片和語音文字組合成單一 JSON 請求

## 錯誤處理設計

### 錯誤類型和處理策略

1. **網路錯誤**
   - 檢測：HTTP 狀態碼非 200
   - 處理：顯示網路錯誤訊息，提供重試選項

2. **API 錯誤**
   - 檢測：回應中包含 error 欄位
   - 處理：顯示具體錯誤訊息，引導用戶修正

3. **語音識別失敗**
   - 檢測：語音文字為空或包含錯誤標記
   - 處理：提供手動輸入選項

4. **圖片處理失敗**
   - 檢測：圖片過大或格式不支援
   - 處理：提示重新拍攝或選擇其他圖片

### 錯誤訊息設計

```javascript
const ERROR_MESSAGES = {
  NETWORK_ERROR: "網路連接失敗，請檢查網路設定後重試",
  API_ERROR: "服務暫時無法使用，請稍後再試",
  VOICE_ERROR: "語音識別失敗，請重新錄製或手動輸入",
  IMAGE_ERROR: "圖片處理失敗，請重新拍攝或選擇其他圖片",
  INVALID_RESPONSE: "收到無效回應，請聯繫技術支援"
};
```

## 安全性設計

### 資料保護

1. **API 金鑰保護**
   - 使用 iOS 捷徑的「詢問輸入」功能安全輸入
   - 不在捷徑中硬編碼敏感資訊
   - 提供金鑰驗證機制

2. **資料傳輸安全**
   - 所有 API 呼叫使用 HTTPS
   - 敏感資料在傳輸前進行適當編碼
   - 實施請求簽名驗證（可選）

3. **本地資料安全**
   - 不在設備上長期存儲敏感資料
   - 使用 iOS 的安全存儲機制
   - 定期清理暫存資料

### 權限管理

1. **必要權限**
   - 相機存取權限（拍照功能）
   - 麥克風存取權限（語音功能）
   - 網路存取權限（API 呼叫）

2. **權限請求策略**
   - 在需要時才請求權限
   - 提供清晰的權限說明
   - 處理權限被拒絕的情況

## 效能優化設計

### 圖片處理優化

1. **圖片壓縮**
   - 自動調整圖片大小（最大 2MB）
   - 使用適當的 JPEG 品質設定
   - 支援多種圖片格式

2. **Base64 編碼優化**
   - 分塊處理大型圖片
   - 實施進度指示器
   - 提供取消操作選項

### 網路請求優化

1. **請求超時設定**
   - GET 請求：10 秒超時
   - POST 請求：30 秒超時
   - 實施重試機制

2. **回應處理優化**
   - 流式處理大型回應
   - 實施回應快取機制
   - 提供離線模式支援

## 用戶體驗設計

### 界面設計原則

1. **簡潔性**：最少的用戶輸入和操作步驟
2. **一致性**：所有捷徑使用相同的視覺和交互模式
3. **反饋性**：每個操作都有明確的視覺或聽覺反饋
4. **容錯性**：優雅處理錯誤情況，提供恢復選項

### 交互流程設計

1. **語音記帳流程**
   - 一鍵啟動 → 語音輸入 → 自動處理 → 結果確認

2. **拍照記帳流程**
   - 一鍵啟動 → 拍照/選圖 → 自動處理 → 結果確認

3. **組合記帳流程**
   - 一鍵啟動 → 拍照/選圖 → 語音補充 → 自動處理 → 結果確認

### 反饋機制設計

1. **進度指示**
   - 顯示處理進度條
   - 提供階段性狀態更新
   - 估算剩餘處理時間

2. **結果展示**
   - 清晰的成功/失敗指示
   - 詳細的處理結果摘要
   - 提供進一步操作選項

## 測試策略

### 功能測試

1. **基本功能測試**
   - 語音識別準確性測試
   - 圖片處理效能測試
   - API 整合穩定性測試

2. **邊界條件測試**
   - 網路中斷情況測試
   - 大型檔案處理測試
   - 並發請求處理測試

### 用戶體驗測試

1. **可用性測試**
   - 新用戶上手難度測試
   - 操作流程效率測試
   - 錯誤恢復能力測試

2. **相容性測試**
   - 不同 iOS 版本測試
   - 不同設備型號測試
   - 不同網路環境測試

## 部署和維護

### 部署策略

1. **階段性部署**
   - 內部測試版本
   - 有限用戶測試版本
   - 公開發布版本

2. **版本管理**
   - 語義化版本號
   - 向後相容性保證
   - 升級路徑規劃

### 維護計劃

1. **監控和日誌**
   - API 呼叫成功率監控
   - 錯誤率和類型統計
   - 用戶使用模式分析

2. **更新和改進**
   - 定期功能更新
   - 效能優化改進
   - 安全性補丁發布