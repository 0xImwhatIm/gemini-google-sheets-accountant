# æ™ºæ…§è¨˜å¸³ GEM ä½¿ç”¨èªªæ˜æ›¸ (V40.4.1)
**ç‰ˆæœ¬ï¼š** 12.1 | **æœ€å¾Œæ›´æ–°ï¼š** 2025-07-06

---

### Part 1: ç”¢å“èªªæ˜ (For Human Users)
**[ä¸­æ–‡]**
ã€Œæ™ºæ…§è¨˜å¸³ GEMã€ä¸æ˜¯ä¸€å€‹å‚³çµ±çš„è¨˜å¸³ Appï¼Œè€Œæ˜¯ä¸€å€‹å±¬æ–¼æ‚¨å€‹äººçš„ã€é«˜åº¦æ™ºæ…§åŒ–çš„ã€ŒAI ç”Ÿæ´»æ•¸æ“šè™•ç†ä¸­æ¨ã€ã€‚å®ƒçš„æ ¸å¿ƒä»»å‹™æ˜¯å°‡æ‚¨ç”Ÿæ´»ä¸­æ‰€æœ‰é›¶ç¢çš„è³‡è¨Šï¼ˆæ”¶æ“šç…§ç‰‡ã€èªéŸ³å‚™è¨»ã€é›»å­éƒµä»¶å¸³å–®ï¼‰ï¼Œé€éå¼·å¤§çš„ AI å¼•æ“ï¼Œè‡ªå‹•è½‰åŒ–ç‚ºçµæ§‹åŒ–ã€æœ‰æ„ç¾©çš„ç´€éŒ„ï¼Œå„²å­˜åœ¨æ‚¨è‡ªå·±çš„ Google Sheet ä¸­ï¼Œè®“æ‚¨å°æ•¸æ“šæ“æœ‰ 100% çš„æ§åˆ¶æ¬Šã€‚

* **æ‰¹é‡æ™ºæ…§è™•ç† (V40.3)ï¼š** GEM èƒ½ç†è§£ä¸¦è™•ç†åƒ IC å¡æ¶ˆè²»ç´€éŒ„é€™æ¨£çš„ã€Œäº¤æ˜“åˆ—è¡¨ã€ã€‚æ‚¨åªéœ€ä¸€å¼µè¢å¹•æˆªåœ–ï¼Œå®ƒå°±èƒ½è‡ªå‹•å°‡è£¡é¢çš„å¤šç­†æ¶ˆè²»é€ä¸€æ‹†åˆ†è¨˜éŒ„ï¼Œä¸¦èƒ½æ™ºæ…§åœ°å€åˆ†å‡ºå“ªäº›æ˜¯ã€Œè²»ç”¨æ”¯å‡ºã€ï¼Œå“ªäº›æ˜¯ã€Œå„²å€¼ã€ã€‚
* **åœ‹éš›åŒ–æ”¯æ´ï¼š** ç³»çµ±èƒ½å¤ æº–ç¢ºåœ°è­˜åˆ¥ä¸åŒåœ‹å®¶çš„è²¨å¹£ï¼ˆå¦‚æ—¥å¹£ Â¥ï¼‰ï¼Œä¸¦å¾æ”¶æ“šä¸­æå–ç¢ºåˆ‡çš„äº¤æ˜“æ™‚é–“ã€‚
* **æ™ºæ…§åˆä½µï¼š** GEM æœƒæ™ºæ…§åœ°å°‡æ–°çš„è³‡è¨Šï¼ˆå¦‚é›»å­ç™¼ç¥¨ï¼‰èˆ‡æ‚¨å…ˆå‰ä¸å®Œæ•´çš„ç´€éŒ„ï¼ˆå¦‚ç…§ç‰‡ï¼‰é€²è¡Œåˆä½µï¼Œé¿å…é‡è¤‡ç´€éŒ„ã€‚
* **ä½¿ç”¨è€…è‡ªè¨‚è¦å‰‡ï¼š** æ‚¨å¯ä»¥åœ¨ Google Sheets ä¸­ï¼Œåƒå¡«è¡¨æ ¼ä¸€æ¨£ç°¡å–®åœ°æ–°å¢éƒµä»¶è™•ç†è¦å‰‡èˆ‡éŒ¯èª¤é€šçŸ¥æ–¹å¼ã€‚

**[English]**
"GEM (Gemini AI Accountant)" is not a traditional accounting app. It is your personal, highly intelligent "AI Life Data-Processing Hub". Its core mission is to automatically transform fragmented information (receipt photos, voice memos, email bills) into structured records using a powerful AI engine. All data is stored in your own Google Sheet, giving you 100% control.

* **Intelligent Batch Processing (V40.3):** GEM can now understand and process "transaction lists," such as IC card statements. With just one screenshot, it automatically breaks down multiple transactions and intelligently distinguishes between "expenses" and "top-ups (transfers)".
* **Internationalization Support:** The system accurately identifies different currencies (e.g., Japanese Yen Â¥) and extracts the exact transaction time from receipts.
* **Smart Reconciliation:** GEM avoids duplicate entries by intelligently merging new information (e.g., an e-invoice) with previous, incomplete records (e.g., a photo).
* **User-Defined Rules:** You can easily add new email processing rules and configure notification preferences directly in Google Sheets.

---

### Part 2: AI Agent å°ˆæ¡ˆäº¤æ¥èªªæ˜ (For AI Agents)
**[ä¸­æ–‡]**
* **ç•¶å‰å°ˆæ¡ˆç‹€æ…‹:** ç©©å®šç‰ˆæœ¬ V40.4ã€‚æ­¤ç‰ˆæœ¬æ“´å……äº†å° PDF ç¹³è²»å–®çš„è¾¨è­˜èƒ½åŠ›ï¼Œä¸¦ä¿®æ­£äº†æ¬Šé™å®£å‘Šæª”ã€‚
* **æ ¸å¿ƒæ¶æ§‹:**
    * **æ™ºæ…§åˆ†æµå™¨ (processImage):** ç©©å®šé‹ä½œï¼Œèƒ½æº–ç¢ºåˆ†æ´¾å–®ç­†æ”¶æ“šèˆ‡äº¤æ˜“åˆ—è¡¨ã€‚
    * **äº¤æ˜“åˆ—è¡¨è™•ç†å™¨ (processImageAsTransactionList):** æ•¸æ“šæµç©©å®šï¼Œèƒ½å°‡ OCR æ–‡å­—å­˜å…¥ `rawText`ï¼Œäº¤æ˜“ JSON ç‰©ä»¶å­˜å…¥ `metaData`ã€‚
    * **å‡ç´šç‰ˆæ­£è¦åŒ– AI (callGeminiForNormalization Prompt):** Prompt ç¶“éå¼·åŒ–ï¼Œå…·å‚™æ˜ç¢ºçš„å¹£åˆ¥åˆ¤æ–·èˆ‡æ™‚é–“æˆ³åˆä½µè¦å‰‡ã€‚
* **é—œéµæ•™è¨“ (V40.4.1 æ–°å¢):**
    * **æˆæ¬Šå¤±æ•ˆå•é¡Œ:** åœ¨æ›´æ–°ç¨‹å¼ç¢¼æˆ–æ–°å¢éœ€è¦æ–°æ¬Šé™çš„åŠŸèƒ½å¾Œï¼Œæ™‚é–“è§¸ç™¼å™¨å¯èƒ½æœƒå›  `Authorization is required` éŒ¯èª¤è€Œå¤±æ•—ã€‚
    * **è§£æ±ºæ–¹æ¡ˆ:** å¿…é ˆé€šéæ‰‹å‹•åŸ·è¡Œä¸€å€‹å‘¼å«æ‰€æœ‰å¿…è¦æœå‹™ï¼ˆ`DriveApp`, `GmailApp`, `SpreadsheetApp`ï¼‰çš„è‡¨æ™‚å‡½å¼ï¼Œä¾†å¼·åˆ¶è§¸ç™¼ Google çš„é‡æ–°æˆæ¬Šæµç¨‹ã€‚

**[English]**
* **Current Project Status:** Stable version V40.4. This version enhances PDF bill recognition and fixes permission declarations.
* **Core Architecture:**
    * **Smart Dispatcher (processImage):** Stable and accurately dispatches single receipts and transaction lists.
    * **Transaction List Processor (processImageAsTransactionList):** Stable data flow, saving OCR text to `rawText` and transaction JSON objects to `metaData`.
    * **Upgraded Normalization AI (callGeminiForNormalization Prompt):** The prompt is enhanced with explicit rules for currency detection and timestamp merging.
* **Key Learnings (New in V40.4.1):**
    * **Authorization Failure Issue:** After updating code or adding features requiring new permissions, time-driven triggers may fail with an `Authorization is required` error.
    * **Solution:** The fix is to manually execute a temporary function that calls all necessary services (`DriveApp`, `GmailApp`, `SpreadsheetApp`) to force Google's re-authorization flow.

---

### Part 3 & 4: (å¿«é€Ÿå…¥é–€ / Quick Start, è¨­å®šè©³è§£ / Detailed Settings)
*(å…§å®¹èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒï¼Œæ­¤è™•ä¸å†é‡è¤‡ã€‚)*

---

### Part 5: å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ (FAQ & Troubleshooting) (V40.4.1 æ–°å¢)

**[ä¸­æ–‡]**
**Q: æˆ‘çš„éƒµä»¶/ç…§ç‰‡è‡ªå‹•è¨˜å¸³åŠŸèƒ½æ²’æœ‰åæ‡‰ï¼Œä½†æˆ‘æ”¶åˆ°äº†æ¨™é¡Œç‚º "Summary of failures" çš„éŒ¯èª¤å ±å‘Šä¿¡ï¼Œè£¡é¢å¯«è‘— `Authorization is required to perform that action.`ï¼Œè©²æ€éº¼è¾¦ï¼Ÿ**

**A:** é€™æ˜¯æœ€å¸¸è¦‹çš„å•é¡Œï¼Œä»£è¡¨æ‚¨çš„è…³æœ¬æ²’æœ‰ç²å¾—åœ¨èƒŒæ™¯åŸ·è¡Œçš„æ¬Šé™ã€‚è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿè§£æ±ºï¼š

1.  **å»ºç«‹è‡¨æ™‚å‡½å¼ï¼š** åœ¨æ‚¨çš„ Apps Script å°ˆæ¡ˆä¸­ï¼Œè²¼ä¸Šæœ¬æ–‡æª”é™„éŒ„ä¸­çš„ `forceReAuthorization_v2` å‡½å¼ã€‚
2.  **åŸ·è¡Œä¸¦æˆæ¬Šï¼š** å¾ç·¨è¼¯å™¨ä¸­æ‰‹å‹•åŸ·è¡Œ `forceReAuthorization_v2` å‡½å¼ã€‚åœ¨å½ˆå‡ºçš„è¦–çª—ä¸­ï¼Œå®Œæˆå®Œæ•´çš„æˆæ¬Šæµç¨‹ï¼ˆé»æ“Šã€Œå¯©æŸ¥æ¬Šé™ã€->ã€Œé€²éšã€->ã€Œå‰å¾€...ã€->ã€Œå…è¨±ã€ï¼‰ã€‚
3.  **æª¢æŸ¥æ—¥èªŒï¼š** åœ¨ã€ŒåŸ·è¡Œç´€éŒ„ã€ä¸­ç¢ºèªçœ‹åˆ°æˆåŠŸè¨Šæ¯ã€‚
4.  **æ¸…ç†ï¼š** æˆåŠŸå¾Œï¼Œå³å¯åˆªé™¤ `forceReAuthorization_v2` å‡½å¼ã€‚

**[English]**
**Q: My automated email/photo accounting isn't working, and I received a failure report email with the error `Authorization is required to perform that action.`. What should I do?**

**A:** This is the most common issue. It means your script lacks the necessary permissions to run in the background. Follow these steps to fix it:

1.  **Create a Temporary Function:** In your Apps Script project, paste the `forceReAuthorization_v2` function from the appendix of this document.
2.  **Run and Authorize:** Manually run the `forceReAuthorization_v2` function from the editor. Complete the full authorization flow in the pop-up window (Click "Review Permissions" -> "Advanced" -> "Go to..." -> "Allow").
3.  **Check Logs:** Verify you see success messages in the "Executions" log.
4.  **Clean Up:** Once successful, you can delete the temporary `forceReAuthorization_v2` function.

---

### é™„éŒ„ (Appendix): è‡¨æ™‚æˆæ¬Šå‡½å¼
```javascript
// è«‹å°‡æ­¤å‡½å¼ç”¨æ–¼è§£æ±º "Authorization is required" éŒ¯èª¤
function forceReAuthorization_v2() {
  try {
    Logger.log('é–‹å§‹å¼·åˆ¶é‡æ–°æˆæ¬Šæµç¨‹...');
    DriveApp.getRootFolder();
    Logger.log('âœ… DriveApp æ¬Šé™å·²è«‹æ±‚');
    GmailApp.getInboxUnreadCount();
    Logger.log('âœ… GmailApp æ¬Šé™å·²è«‹æ±‚');
    SpreadsheetApp.getActiveSpreadsheet();
    Logger.log('âœ… SpreadsheetApp æ¬Šé™å·²è«‹æ±‚');
    Logger.log('ğŸ‰ æˆæ¬Šæµç¨‹å·²æˆåŠŸè§¸ç™¼ï¼');
  } catch (e) {
    Logger.log('âŒ è§¸ç™¼æˆæ¬Šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + e.toString());
  }
}
