# V47.1 é›»å­ç™¼ç¥¨è™•ç†å®Œæ•´ä¿®å¾©æŒ‡å—

## ğŸ¯ å•é¡Œç¸½çµ
æ ¹æ“šæ‚¨çš„å›é¥‹ï¼Œç›®å‰æœ‰ä»¥ä¸‹å•é¡Œï¼š
1. âŒ **éƒµä»¶æœªæ¨™è¨˜ç‚ºå·²è®€** - è™•ç†å¾Œçš„éƒµä»¶ä»é¡¯ç¤ºç‚ºæœªè®€
2. âŒ **éƒ¨åˆ†éƒµä»¶æœªè¢«è™•ç†** - ä»æœ‰éƒµä»¶æ²’æœ‰è¢«è¨˜éŒ„
3. âŒ **æ¬„ä½å’Œé‡‘é¡éŒ¯èª¤** - Apple æ”¶æ“šé‡‘é¡é¡¯ç¤ºç‚º 0ï¼Œæ¬„ä½æ ¼å¼ä¸æ­£ç¢º

## ğŸš€ å®Œæ•´è§£æ±ºæ–¹æ¡ˆ

### æ­¥é©Ÿ 1ï¼šéƒ¨ç½²å¢å¼·ç‰ˆè™•ç†ç¨‹å¼
1. å°‡ `V47_EMAIL_PROCESSING_ENHANCED.gs` å…§å®¹è¤‡è£½åˆ°æ‚¨çš„ Apps Script å°ˆæ¡ˆ
2. å°‡ `V47_TRIGGER_UPDATE.gs` å…§å®¹è¤‡è£½åˆ°æ‚¨çš„ Apps Script å°ˆæ¡ˆ
3. å„²å­˜æ‰€æœ‰æª”æ¡ˆ

### æ­¥é©Ÿ 2ï¼šåŸ·è¡Œå®Œæ•´ä¿®å¾©
```javascript
// åœ¨ Apps Script ç·¨è¼¯å™¨ä¸­åŸ·è¡Œé€™å€‹å‡½æ•¸
runCompleteDataFix();
```

é€™å€‹å‡½æ•¸æœƒè‡ªå‹•ï¼š
- âœ… æ›´æ–°è§¸ç™¼å™¨ç‚ºå¢å¼·ç‰ˆ
- âœ… ä¿®å¾©ç¾æœ‰è¨˜éŒ„çš„æ¬„ä½å•é¡Œ
- âœ… æª¢æŸ¥ä¸¦è™•ç†é‡è¤‡è¨˜éŒ„
- âœ… æ¨™è¨˜å·²è™•ç†éƒµä»¶ç‚ºå·²è®€
- âœ… æ¸¬è©¦å¢å¼·ç‰ˆè™•ç†åŠŸèƒ½

### æ­¥é©Ÿ 3ï¼šæ‰‹å‹•æ¸¬è©¦ç‰¹å®šå•é¡Œ
```javascript
// æ¸¬è©¦ Apple æ”¶æ“šè™•ç†
manualProcessSpecificEmail();

// æ¸¬è©¦å¢å¼·ç‰ˆéƒµä»¶è™•ç†
manualTestEnhancedEmailProcessing();

// æ‰¹æ¬¡æ¨™è¨˜éƒµä»¶ç‚ºå·²è®€
markProcessedEmailsAsRead();
```

## ğŸ”§ ä¸»è¦æ”¹é€²å…§å®¹

### 1. å¢å¼·ç‰ˆéƒµä»¶è§£æ
- **Apple æ”¶æ“šå°ˆç”¨è§£æ**ï¼šæ­£ç¢ºæå–é‡‘é¡ã€å¹£åˆ¥ã€å•†å“åç¨±
- **é›»å­ç™¼ç¥¨è§£æ**ï¼šæ”¯æ´å¤šç¨®æ ¼å¼çš„é›»å­ç™¼ç¥¨
- **æ™ºæ…§åˆ†é¡**ï¼šæ ¹æ“šå•†å®¶è‡ªå‹•åˆ†é¡
- **å¤šé‡é‡‘é¡æ¨¡å¼**ï¼šæ”¯æ´å„ç¨®é‡‘é¡æ ¼å¼

### 2. ä¿®æ­£æ¬„ä½å°æ‡‰
```
A: TIMESTAMP (æ—¥æœŸ)
B: AMOUNT (åŸå§‹é‡‘é¡)
C: CURRENCY (å¹£åˆ¥)
D: EXCHANGE RATE (åŒ¯ç‡)
E: Amount (TWD) (å°å¹£é‡‘é¡ - å…¬å¼è¨ˆç®—)
F: CATEGORY (é¡åˆ¥)
G: ITEM (æè¿°)
...å…¶ä»–æ¬„ä½
```

### 3. å¼·åŒ–éƒµä»¶æ¨™è¨˜
- è™•ç†å®Œæˆå¾Œç¢ºå¯¦æ¨™è¨˜ç‚ºå·²è®€
- é¿å…é‡è¤‡è™•ç†åŒä¸€å°éƒµä»¶
- å¢åŠ è™•ç†ç‹€æ…‹æª¢æŸ¥

### 4. æ”¹é€²æœå°‹æ¢ä»¶
```javascript
const searchQueries = [
  'subject:é›»å­ç™¼ç¥¨ is:unread',
  'subject:ç™¼ç¥¨ is:unread', 
  'subject:æ”¶æ“š is:unread',
  'subject:invoice is:unread',
  'subject:receipt is:unread',
  'from:Apple subject:æ”¶æ“š is:unread',
  'from:no_reply@email.apple.com is:unread',
  // ... æ›´å¤šæ¢ä»¶
];
```

## ğŸ“Š Apple æ”¶æ“šè™•ç†ç¯„ä¾‹

### ä¿®å¾©å‰çš„å•é¡Œè¨˜éŒ„ï¼š
```
2025-07-27 | 0 | TWD | 1 | 0 | å…¶ä»– | ä½ çš„ Apple æ”¶æ“š
```

### ä¿®å¾©å¾Œçš„æ­£ç¢ºè¨˜éŒ„ï¼š
```
2025-07-27 | 99 | TWD | 1 | 99 | è‚² | Apple - æŸå€‹æ‡‰ç”¨ç¨‹å¼
```

## ğŸ” å•é¡Œè¨ºæ–·å·¥å…·

### æª¢æŸ¥ç‰¹å®šéƒµä»¶è™•ç†
```javascript
function debugSpecificEmail() {
  const threads = GmailApp.search('from:Apple subject:æ”¶æ“š', 0, 1);
  if (threads.length > 0) {
    const message = threads[0].getMessages()[0];
    console.log('ä¸»æ—¨:', message.getSubject());
    console.log('å…§å®¹:', message.getPlainBody());
    
    const result = processEmailEnhanced(message);
    console.log('è§£æçµæœ:', result);
  }
}
```

### æª¢æŸ¥ç¾æœ‰è¨˜éŒ„
```javascript
function checkExistingRecords() {
  const ss = SpreadsheetApp.openById('YOUR_SHEET_ID');
  const sheet = ss.getSheetByName('All Records');
  const values = sheet.getDataRange().getValues();
  
  // æª¢æŸ¥æœ€è¿‘10ç­†è¨˜éŒ„
  for (let i = Math.max(1, values.length - 10); i < values.length; i++) {
    const row = values[i];
    console.log(`ç¬¬${i+1}è¡Œ: ${row[0]} | ${row[1]} | ${row[2]} | ${row[6]}`);
  }
}
```

## ğŸ› ï¸ æ‰‹å‹•ä¿®å¾©æ­¥é©Ÿï¼ˆå¦‚æœè‡ªå‹•ä¿®å¾©å¤±æ•—ï¼‰

### ä¿®å¾©è§¸ç™¼å™¨
1. é€²å…¥ Apps Script ç·¨è¼¯å™¨
2. é»æ“Šå·¦å´ã€Œè§¸ç™¼æ¢ä»¶ã€
3. åˆªé™¤æ‰€æœ‰ç¾æœ‰è§¸ç™¼å™¨
4. å»ºç«‹æ–°è§¸ç™¼å™¨ï¼š
   - å‡½å¼ï¼š`processAutomatedEmailsEnhanced`
   - äº‹ä»¶ä¾†æºï¼šæ™‚é–“é©…å‹•
   - æ™‚é–“å‹è§¸ç™¼æ¢ä»¶ï¼šåˆ†é˜è¨ˆæ™‚å™¨
   - åˆ†é˜é–“éš”ï¼šæ¯ 15 åˆ†é˜

### ä¿®å¾©ç¾æœ‰éŒ¯èª¤è¨˜éŒ„
1. é–‹å•Ÿ Google Sheets
2. æ‰¾åˆ°é‡‘é¡ç‚º 0 çš„è¨˜éŒ„
3. æ‰‹å‹•æ›´æ­£ï¼š
   - Bæ¬„ï¼šæ­£ç¢ºé‡‘é¡
   - Cæ¬„ï¼šæ­£ç¢ºå¹£åˆ¥
   - Dæ¬„ï¼šæ­£ç¢ºåŒ¯ç‡
   - Fæ¬„ï¼šæ­£ç¢ºé¡åˆ¥

### æ‰‹å‹•æ¨™è¨˜éƒµä»¶ç‚ºå·²è®€
1. é€²å…¥ Gmail
2. æœå°‹ï¼š`subject:æ”¶æ“š is:unread`
3. é¸æ“‡å·²è™•ç†çš„éƒµä»¶
4. é»æ“Šã€Œæ¨™è¨˜ç‚ºå·²è®€ã€

## ğŸ“ˆ ç›£æ§å’Œé©—è­‰

### æª¢æŸ¥è™•ç†æ•ˆæœ
1. **åŸ·è¡Œè¨˜éŒ„æª¢æŸ¥**ï¼š
   - é€²å…¥ Apps Script â†’ åŸ·è¡Œ â†’ åŸ·è¡Œè¨˜éŒ„
   - æŸ¥çœ‹æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
   - ç¢ºèªè™•ç†æ•¸é‡

2. **Google Sheets æª¢æŸ¥**ï¼š
   - æª¢æŸ¥æ–°è¨˜éŒ„çš„é‡‘é¡æ˜¯å¦æ­£ç¢º
   - ç¢ºèªé¡åˆ¥åˆ†é¡æ˜¯å¦åˆç†
   - é©—è­‰æ—¥æœŸå’Œæè¿°

3. **Gmail æª¢æŸ¥**ï¼š
   - ç¢ºèªè™•ç†éçš„éƒµä»¶å·²æ¨™è¨˜ç‚ºå·²è®€
   - æª¢æŸ¥æ˜¯å¦é‚„æœ‰æœªè™•ç†çš„ç›¸é—œéƒµä»¶

### æ•ˆèƒ½ç›£æ§
```javascript
function getProcessingStats() {
  const ss = SpreadsheetApp.openById('YOUR_SHEET_ID');
  const sheet = ss.getSheetByName('All Records');
  const values = sheet.getDataRange().getValues();
  
  let emailRecords = 0;
  let todayRecords = 0;
  const today = new Date().toISOString().split('T')[0];
  
  for (let i = 1; i < values.length; i++) {
    const source = values[i][16]; // Qæ¬„ï¼šSOURCE
    const date = values[i][0]; // Aæ¬„ï¼šTIMESTAMP
    
    if (source && source.includes('Email')) {
      emailRecords++;
      if (date && date.toString().includes(today)) {
        todayRecords++;
      }
    }
  }
  
  console.log(`ç¸½éƒµä»¶è¨˜éŒ„: ${emailRecords}`);
  console.log(`ä»Šæ—¥è™•ç†: ${todayRecords}`);
}
```

## ğŸš¨ å¸¸è¦‹å•é¡Œè§£æ±º

### Q1: é‡‘é¡ä»ç„¶æ˜¯ 0
**åŸå› **ï¼šéƒµä»¶æ ¼å¼ç‰¹æ®Šï¼Œè§£ææ¨¡å¼ä¸åŒ¹é…
**è§£æ±º**ï¼š
1. åŸ·è¡Œ `debugSpecificEmail()` æŸ¥çœ‹éƒµä»¶å…§å®¹
2. æ ¹æ“šå¯¦éš›æ ¼å¼èª¿æ•´è§£ææ¨¡å¼
3. æ‰‹å‹•ä¿®æ­£ç¾æœ‰éŒ¯èª¤è¨˜éŒ„

### Q2: éƒµä»¶æœªæ¨™è¨˜ç‚ºå·²è®€
**åŸå› **ï¼šæ¬Šé™å•é¡Œæˆ–åŸ·è¡Œé †åºå•é¡Œ
**è§£æ±º**ï¼š
1. é‡æ–°æˆæ¬Š Gmail æ¬Šé™
2. åŸ·è¡Œ `markProcessedEmailsAsRead()`
3. æª¢æŸ¥è§¸ç™¼å™¨åŸ·è¡Œè¨˜éŒ„

### Q3: éƒ¨åˆ†éƒµä»¶æœªè¢«è™•ç†
**åŸå› **ï¼šæœå°‹æ¢ä»¶ä¸å¤ å…¨é¢
**è§£æ±º**ï¼š
1. æª¢æŸ¥éƒµä»¶ä¸»æ—¨å’Œå¯„ä»¶è€…
2. åœ¨æœå°‹æ¢ä»¶ä¸­åŠ å…¥æ–°çš„æ¨¡å¼
3. æ‰‹å‹•æ¸¬è©¦ç‰¹å®šéƒµä»¶

### Q4: é‡è¤‡è¨˜éŒ„
**åŸå› **ï¼šåŒä¸€å°éƒµä»¶è¢«è™•ç†å¤šæ¬¡
**è§£æ±º**ï¼š
1. åŸ·è¡Œ `checkAndFixDuplicateRecords()`
2. æ‰‹å‹•åˆªé™¤é‡è¤‡è¨˜éŒ„
3. ç¢ºèªå»é‡æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ

## âœ… ä¿®å¾©å®Œæˆæª¢æŸ¥æ¸…å–®

- [ ] å¢å¼·ç‰ˆè™•ç†ç¨‹å¼å·²éƒ¨ç½²
- [ ] è§¸ç™¼å™¨å·²æ›´æ–°ç‚ºå¢å¼·ç‰ˆ
- [ ] ç¾æœ‰éŒ¯èª¤è¨˜éŒ„å·²ä¿®å¾©
- [ ] éƒµä»¶æ¨™è¨˜åŠŸèƒ½æ­£å¸¸
- [ ] Apple æ”¶æ“šé‡‘é¡æ­£ç¢ºè§£æ
- [ ] æ¬„ä½å°æ‡‰å®Œå…¨æ­£ç¢º
- [ ] ç„¡é‡è¤‡è¨˜éŒ„
- [ ] åŸ·è¡Œè¨˜éŒ„ç„¡éŒ¯èª¤
- [ ] æ–°éƒµä»¶èƒ½æ­£ç¢ºè™•ç†

## ğŸ”® å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **å®šæœŸç¶­è­·**ï¼šæ¯é€±åŸ·è¡Œä¸€æ¬¡è¨ºæ–·æª¢æŸ¥
2. **è¦å‰‡æ“´å±•**ï¼šæ ¹æ“šæ–°çš„éƒµä»¶æ ¼å¼èª¿æ•´è§£æè¦å‰‡
3. **æ•ˆèƒ½å„ªåŒ–**ï¼šç›£æ§è™•ç†æ™‚é–“ï¼Œå¿…è¦æ™‚èª¿æ•´è§¸ç™¼é »ç‡
4. **é€šçŸ¥æ©Ÿåˆ¶**ï¼šåŠ å…¥è™•ç†æ‘˜è¦é€šçŸ¥
5. **å‚™ä»½æ©Ÿåˆ¶**ï¼šå®šæœŸå‚™ä»½é‡è¦é…ç½®å’Œè³‡æ–™

---

**åŸ·è¡Œé †åºå»ºè­°**ï¼š
1. `runCompleteDataFix()` - å®Œæ•´ä¿®å¾©
2. ç­‰å¾… 15 åˆ†é˜è§€å¯Ÿè§¸ç™¼å™¨åŸ·è¡Œ
3. æª¢æŸ¥ Google Sheets å’Œ Gmail ç‹€æ…‹
4. å¦‚æœ‰å•é¡Œï¼ŒåŸ·è¡Œå°æ‡‰çš„è¨ºæ–·å‡½æ•¸

**é æœŸçµæœ**ï¼š
- âœ… æ‰€æœ‰é›»å­ç™¼ç¥¨å’Œæ”¶æ“šéƒµä»¶æ­£ç¢ºè™•ç†
- âœ… é‡‘é¡ã€é¡åˆ¥ã€æè¿°æº–ç¢ºç„¡èª¤
- âœ… è™•ç†å¾Œçš„éƒµä»¶è‡ªå‹•æ¨™è¨˜ç‚ºå·²è®€
- âœ… ç„¡é‡è¤‡æˆ–éºæ¼è¨˜éŒ„

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-07-27  
**é©ç”¨ç‰ˆæœ¬**ï¼šV47.1  
**ä¿®å¾©ç¨‹åº¦**ï¼šå®Œæ•´ä¿®å¾©