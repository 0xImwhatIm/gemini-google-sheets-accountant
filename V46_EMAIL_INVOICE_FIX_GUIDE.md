# V46 電子發票處理修復指南

## 問題描述
V46 版本的電子發票自動處理功能可能無法正常工作，導致 Gmail 中的電子發票沒有被自動記錄到 Google Sheets 中。

## 問題原因分析
1. **觸發器設定問題**：時間觸發器可能沒有正確設定或執行
2. **函數調用問題**：主程式無法找到實際的處理函數
3. **郵件規則配置問題**：EmailRules 工作表可能缺失或配置錯誤
4. **權限問題**：Gmail API 權限可能不足

## 快速修復步驟

### 步驟 1：診斷問題
1. 打開 Google Apps Script 編輯器
2. 將 `email-diagnosis-fix.gs` 檔案內容複製到專案中
3. 執行 `diagnoseEmailProcessing()` 函數
4. 查看執行記錄，了解具體問題

### 步驟 2：執行修復
1. 在 Apps Script 編輯器中執行 `fixEmailProcessing()` 函數
2. 這會自動：
   - 建立 EmailRules 工作表（如果不存在）
   - 重新設定觸發器
   - 測試執行功能

### 步驟 3：手動測試
1. 執行 `manualTestEmailProcessing()` 函數
2. 檢查是否能正確解析郵件內容
3. 確認記錄是否正確儲存到 Google Sheets

### 步驟 4：設定觸發器（如果自動設定失敗）
1. 在 Apps Script 編輯器中，點擊左側「觸發條件」
2. 點擊「新增觸發條件」
3. 設定：
   - 函式：`processAutomatedEmailsV46Fixed`
   - 事件來源：`時間驅動`
   - 時間型觸發條件：`分鐘計時器`
   - 分鐘間隔：`每 15 分鐘`

## 檢查清單

### 基本配置檢查
- [ ] MAIN_LEDGER_ID 已設定
- [ ] GEMINI_API_KEY 已設定
- [ ] All Records 工作表存在
- [ ] EmailRules 工作表存在並有規則

### 觸發器檢查
- [ ] 觸發器已建立
- [ ] 觸發器函數名稱正確
- [ ] 觸發器執行頻率適當（建議 15 分鐘）

### 權限檢查
- [ ] Gmail API 權限已授權
- [ ] Google Sheets API 權限已授權
- [ ] 腳本執行權限正常

### 功能測試
- [ ] 手動執行處理函數成功
- [ ] 能夠搜尋到相關郵件
- [ ] 郵件內容解析正常
- [ ] 記錄成功儲存到 Sheets

## 常見問題解決

### Q1: 觸發器不執行
**解決方案：**
1. 檢查觸發器設定是否正確
2. 查看 Apps Script 執行記錄是否有錯誤
3. 確認函數名稱拼寫正確
4. 重新建立觸發器

### Q2: 找不到郵件
**解決方案：**
1. 檢查 Gmail 搜尋條件是否正確
2. 確認郵件確實存在且未讀
3. 檢查 Gmail API 權限
4. 嘗試手動搜尋測試

### Q3: 解析失敗
**解決方案：**
1. 檢查郵件格式是否支援
2. 查看錯誤記錄了解具體問題
3. 嘗試簡化解析邏輯
4. 手動測試特定郵件

### Q4: 儲存失敗
**解決方案：**
1. 檢查 Google Sheets 權限
2. 確認工作表名稱正確
3. 檢查資料格式是否正確
4. 查看 Sheets API 配額

## 進階配置

### EmailRules 工作表設定
在 Google Sheets 中建立 EmailRules 工作表，包含以下欄位：

| Query | Type | Description |
|-------|------|-------------|
| subject:電子發票 is:unread | HTML | 電子發票郵件 |
| subject:發票 is:unread | HTML | 一般發票郵件 |
| subject:收據 is:unread | HTML | 收據郵件 |
| has:attachment filename:csv is:unread | CSV | CSV 附件郵件 |

### 自定義搜尋條件
可以根據您的需求修改搜尋條件：
- `from:noreply@invoice.com.tw` - 特定寄件者
- `subject:統一發票` - 特定主旨關鍵字
- `has:attachment` - 有附件的郵件
- `newer_than:1d` - 最近一天的郵件

## 監控和維護

### 定期檢查
1. **每週檢查**：執行 `diagnoseEmailProcessing()` 確認功能正常
2. **每月檢查**：查看處理統計，確認沒有遺漏
3. **季度檢查**：更新郵件規則，適應新的發票格式

### 日誌監控
定期查看 Apps Script 執行記錄：
1. 點擊「執行」→「執行記錄」
2. 查看是否有錯誤或警告
3. 注意處理數量是否正常

### 效能優化
1. **限制搜尋範圍**：使用 `newer_than:7d` 限制搜尋最近 7 天
2. **批次處理**：一次處理多封郵件
3. **錯誤處理**：加強錯誤處理和重試機制

## 升級建議

如果 V46 修復版仍有問題，建議升級到 V47.1：
1. V47.1 已完全修復電子發票處理問題
2. 包含更穩定的錯誤處理機制
3. 支援更多郵件格式和附件類型

## 技術支援

如果按照此指南仍無法解決問題，請：
1. 收集診斷結果和錯誤記錄
2. 提供具體的錯誤訊息
3. 說明您的使用環境和配置
4. 聯繫技術支援或提交 Issue

---

**最後更新：** 2025-07-27  
**適用版本：** V46.x  
**建議升級版本：** V47.1+