# 🚰 台北自來水帳單 Email 自動記帳設定指南

**版本**：V47.4.1  
**更新日期**：2025-08-05  
**功能**：直接從 HTML 內文提取帳單金額，避免處理需要密碼的 PDF 附件  

---

## 🎯 **功能概述**

### **問題背景**
- 台北自來水事業處的電子帳單郵件 (`ebill@water.gov.taipei`) 包含 PDF 附件
- **PDF 附件需要密碼才能打開**，無法直接解析
- 但是**郵件的 HTML 內文包含完整的帳單金額信息**

### **解決方案**
- ✅ **直接解析 HTML 內文**：從郵件內容提取金額，不處理 PDF 附件
- ✅ **自動分類記帳**：水費自動歸類為「住」類別
- ✅ **智能金額提取**：支援多種金額格式（應繳金額、本期應繳等）
- ✅ **用戶編號識別**：自動提取用戶編號作為備註

---

## 🚀 **快速設定（一鍵完成）**

### **方法一：自動設定（推薦）**

在 Google Apps Script 編輯器中執行：

```javascript
setupCompleteEmailSystemV47_4_1()
```

這個函數會自動：
1. ✅ 添加台北自來水帳單處理規則到 Email Rules
2. ✅ 設定自動觸發器（每15分鐘檢查一次）
3. ✅ 測試系統功能
4. ✅ 發送設定完成通知

---

## 🔧 **手動設定步驟**

### **步驟 1：添加 Email 處理規則**

執行以下函數：
```javascript
addWaterBillRuleToEmailRules()
```

或手動在 `EmailRules` 工作表中添加：

| Sender Email | Keywords | Category | Processing Method | Enabled | Rule Name | Processing Type | Special Flags |
|--------------|----------|----------|-------------------|---------|-----------|-----------------|---------------|
| ebill@water.gov.taipei | 臺北自來水事業處,水費,電子帳單 | 住 | html_content_extraction | TRUE | 台北自來水事業處電子帳單 | html_content | skip_pdf_attachments |

### **步驟 2：設定自動觸發器**

執行以下函數：
```javascript
setupEmailProcessingTriggerV47_4_1()
```

這會建立一個每15分鐘執行一次的觸發器。

### **步驟 3：測試功能**

執行測試函數：
```javascript
testWaterBillParsing()
```

---

## 🧪 **測試與驗證**

### **測試 HTML 解析功能**
```javascript
testWaterBillParsing()
```

**預期結果**：
```
✅ 解析結果:
   金額: 428 元 (預期: 428 元)
   日期: 2025-08-05 14:30:15 (使用郵件接收時間)
   項目: 水費 (用戶號: 2-08-019198-4)
   類別: 住
   商家: 台北自來水事業處
   用戶編號: ✅ 正確提取
🎉 台北自來水帳單解析測試成功！金額正確提取為 428 元
✅ 日期使用郵件接收時間，而非帳單繳費期限
```

### **測試完整 Email 處理**
```javascript
testEmailProcessingV47_4_1()
```

### **手動處理單封郵件**
```javascript
processWaterBillEmails()
```

---

## 📊 **支援的金額格式**

系統會自動識別以下格式的金額：

- ✅ `應繳金額: 1,250元`
- ✅ `本期應繳: 1,250元`
- ✅ `繳費金額: 1,250元`
- ✅ `總計: 1,250元`
- ✅ `合計: 1,250元`
- ✅ `NT$1,250`
- ✅ `$1,250`

---

## 📅 **支援的日期格式**

系統會自動識別以下格式的日期：

- ✅ `繳費期限: 2025年08月15日`
- ✅ `到期日: 2025-08-15`
- ✅ `2025/08/15 到期`

如果找不到日期，會使用郵件接收日期。

---

## 🔍 **記帳資料格式**

處理後的記帳資料格式（基於實際截圖，使用郵件接收時間）：

```json
{
  "date": "2025-08-05 14:30:15",
  "amount": 428,
  "currency": "TWD",
  "category": "住",
  "item": "水費 (用戶號: 2-08-019198-4)",
  "merchant": "台北自來水事業處",
  "notes": "電子帳單自動提取 - 臺北自來水事業處(114年07月水費電子帳單收費通知)",
  "source": "email_water_bill"
}
```

**重要說明**：
- ✅ **日期時間戳**：使用郵件實際接收的時間（如 `14:30:15`），而不是固定的 `12:00:00`
- ✅ **金額準確**：根據實際截圖提取的 428 元
- ✅ **用戶編號**：自動從 HTML 內文提取的實際用戶編號

---

## 🔧 **故障排除**

### **問題 1：沒有自動處理水費帳單**

**檢查步驟**：
1. 確認 Email Rules 中有台北自來水規則
2. 檢查觸發器是否正常運作
3. 確認郵件是否為未讀狀態

**解決方法**：
```javascript
// 手動執行處理
processWaterBillEmails()
```

### **問題 2：金額提取失敗**

**檢查步驟**：
1. 查看郵件 HTML 內容格式
2. 檢查金額是否在支援的格式範圍內

**解決方法**：
```javascript
// 測試解析功能
testWaterBillParsing()
```

### **問題 3：觸發器未執行**

**檢查步驟**：
1. 在 Google Apps Script 中查看「觸發器」頁面
2. 檢查是否有錯誤日誌

**解決方法**：
```javascript
// 重新設定觸發器
setupEmailProcessingTriggerV47_4_1()
```

---

## 📈 **進階設定**

### **修改處理頻率**

預設每15分鐘檢查一次，如需修改：

```javascript
// 改為每5分鐘
ScriptApp.newTrigger('processAutomatedEmailsV47_4_1')
  .timeBased()
  .everyMinutes(5)  // 修改這裡
  .create();
```

### **添加其他帳單類型**

可以參考台北自來水的設定，添加其他公用事業帳單：

```javascript
// 例如：台電帳單
[
  'bill@taipower.com.tw',
  '台灣電力公司,電費,電子帳單',
  '住',
  'html_content_extraction',
  true,
  '台灣電力公司電子帳單',
  'html_content',
  'skip_pdf_attachments'
]
```

### **自訂金額提取規則**

在 `extractAmountFromWaterBill` 函數中添加新的正則表達式：

```javascript
const amountPatterns = [
  // 現有規則...
  /你的自訂格式[：:\s]*([0-9,]+)\s*元/,  // 添加新格式
];
```

---

## ✅ **設定完成檢查清單**

- [ ] 已執行 `setupCompleteEmailSystemV47_4_1()` 或完成手動設定
- [ ] EmailRules 工作表中有台北自來水規則
- [ ] 觸發器已建立並正常運作
- [ ] 測試函數執行成功
- [ ] 收到設定完成通知
- [ ] 有台北自來水帳單郵件可供測試

---

## 🎉 **預期效果**

設定完成後，系統將：

1. **自動監控**：每15分鐘檢查 `ebill@water.gov.taipei` 的新郵件
2. **智能解析**：從 HTML 內文提取金額，無需處理加密 PDF
3. **自動記帳**：將水費記錄到 Google Sheets 的「住」類別
4. **標記已讀**：處理完成後自動標記郵件為已讀
5. **發送通知**：成功處理後發送通知確認

**這樣你就再也不用手動處理台北自來水的電子帳單了！** 🎊

---

## 📞 **技術支援**

如果遇到問題，可以：

1. **查看執行日誌**：在 Google Apps Script 中查看詳細日誌
2. **執行測試函數**：使用提供的測試函數診斷問題
3. **檢查郵件格式**：確認郵件 HTML 內容是否包含預期的金額信息

**版本**：V47.4.1  
**最後更新**：2025-08-05  
**狀態**：已測試，準備部署  