# 財政部電子發票自動處理設定指南

## 🏛️ 問題描述

財政部電子發票郵件無法被正確識別和處理，顯示「無符合條件的可處理內容」。

## 🔧 解決方案

### **步驟 1: 執行自動設定**

在 Google Apps Script 中執行以下函數：

```javascript
setupMOFInvoiceRule()
```

這個函數會自動：
- 檢查 EmailRules 工作表是否存在
- 新增財政部電子發票的處理規則
- 設定正確的郵件識別條件

### **步驟 2: 驗證設定**

執行測試函數確認設定成功：

```javascript
testMOFInvoiceSetup()
```

### **步驟 3: 快速修復 (推薦)**

執行一鍵修復函數：

```javascript
quickFixMOFInvoice()
```

### **步驟 4: 測試 CSV 格式**

測試 CSV 格式處理邏輯：

```javascript
testMOFCSVFormat()
```

### **步驟 5: 完整系統測試**

執行完整測試包含財政部電子發票：

```javascript
finalSystemTestV49_4_1()
```

## 📋 **自動新增的郵件規則**

| 欄位 | 值 |
|------|-----|
| 寄件者 | `noreply@einvoice.nat.gov.tw` |
| 主旨關鍵字 | `財政部電子發票整合服務平台` |
| 處理類型 | `MOF_CSV` |
| 備註 | `財政部電子發票 CSV 特殊格式處理` |

## 🔍 **財政部 CSV 特殊格式處理**

### **實際格式範例**
```
表頭=M|載具名稱|載具號碼|發票日期|商店統編|商店店名|發票號碼|總金額|發票狀態|明細=D|發票號碼|小計|品項名稱|
M|手機條碼|/PZWC6KQ|20250901|80354145|全聯實業股份有限公司民生社區分公司|SA53840100|426|開立|
D|SA53840100|0|全菲仕樂印花張|
D|SA53840100|126|統一LP33機|
```

### **格式特點**
- 使用 `|` (管道符號) 作為分隔符
- 表頭行以 `表頭=M` 開始，包含完整欄位定義
- 主發票記錄以 `M` 開始
- 發票明細記錄以 `D` 開始
- 日期格式為 `YYYYMMDD`
- 欄位順序：載具名稱|載具號碼|發票日期|商店統編|商店店名|發票號碼|總金額|發票狀態

### **處理邏輯**
1. 自動識別財政部郵件
2. 解析 CSV 附件使用 `|` 分隔符
3. 尋找 `表頭=M` 行確定欄位位置
4. 處理所有 `M` 開頭的資料行
5. 轉換日期格式並寫入試算表

## 🧪 **測試結果範例**

```
🏛️ 設定財政部電子發票規則...
✅ 財政部電子發票規則已新增

📄 CSV 資料行數: 15
📋 找到表頭: 表頭=M|發票日期|商店店名|發票號碼|總金額
🗺️ 欄位對應: {"發票日期":1,"商店店名":2,"發票號碼":3,"總金額":4}
💰 處理發票: 7-ELEVEN - 89元 (AB12345678)
💰 處理發票: 全家便利商店 - 156元 (CD87654321)
✅ 財政部 CSV 處理完成，共處理 2 筆記錄
```

## 🚀 **使用方式**

### **自動處理**
設定完成後，系統會自動：
1. 監控來自 `noreply@einvoice.nat.gov.tw` 的郵件
2. 識別主旨包含「財政部電子發票整合服務平台」的郵件
3. 自動解析 CSV 附件
4. 將發票資料寫入試算表
5. 標記郵件為已讀

### **手動觸發**
如需手動處理郵件：

```javascript
processAutomatedEmails()
```

## ⚠️ **注意事項**

1. **郵件規則**: 確保 EmailRules 工作表存在且格式正確
2. **CSV 格式**: 財政部 CSV 必須包含必要欄位
3. **權限設定**: 確保 Gmail API 權限已正確設定
4. **測試環境**: 建議先在測試環境驗證

## 🔧 **故障排除**

### **常見問題**

**Q: 郵件仍然無法被處理？**
A: 檢查 EmailRules 工作表中是否有正確的規則，執行 `testMOFInvoiceSetup()` 驗證。

**Q: CSV 解析失敗？**
A: 確認 CSV 格式是否正確，檢查是否有 `表頭=M` 行和 `M` 開頭的資料行。

**Q: 日期格式錯誤？**
A: 財政部 CSV 使用 `YYYYMMDD` 格式，系統會自動轉換為標準日期格式。

## 📞 **支援**

如有問題，請：
1. 執行 `checkSystemHealth()` 檢查系統狀態
2. 查看執行日誌了解詳細錯誤資訊
3. 確認 Gmail 和 Sheets API 權限設定

---

**V49.4.1 更新** - 財政部電子發票自動處理功能已完整實現！