# V49.5.0 完整測試指南

## 🧪 **測試概覽**

這個指南將幫助你全面測試 V49.5.0 精簡穩定版的所有功能，確保系統運作正常。

## 📋 **測試前準備**

### **1. 部署代碼**
1. 開啟 [Google Apps Script](https://script.google.com/)
2. 創建新專案或開啟現有專案
3. 將 `Code.gs` 的內容完整複製到編輯器
4. 儲存專案 (Ctrl+S)

### **2. 設定配置**
確保以下配置已正確設定：
```javascript
// 在 Google Apps Script 編輯器中，點擊「專案設定」→「指令碼屬性」
// 添加以下屬性：
GEMINI_API_KEY: "你的 Gemini API 金鑰"
MAIN_LEDGER_ID: "你的 Google Sheets ID"
```

## 🔍 **階段一：基礎系統測試**

### **測試 1.1：版本確認**
```javascript
// 在 Google Apps Script 編輯器中執行
function testVersion() {
  const version = getVersionInfo();
  console.log('版本資訊:', version);
  
  // 預期結果：
  // version: "V49.5.0"
  // description: "精簡穩定版 - 程式碼清理與優化"
  // status: "production-ready"
}
```

### **測試 1.2：系統健康檢查**
```javascript
// 執行系統健康檢查
function runHealthCheck() {
  checkSystemHealth();
  
  // 檢查執行日誌，應該看到：
  // ✅ 配置檢查通過
  // ✅ API 連接正常
  // ✅ 試算表連接正常
}
```

### **測試 1.3：系統診斷**
```javascript
// 執行新的系統診斷功能
function runDiagnosis() {
  diagnoseSystem();
  
  // 檢查執行日誌，應該看到：
  // ✅ 配置狀態正常
  // ✅ EmailRules 工作表存在
  // ✅ Gmail 連接正常
}
```

## 🤖 **階段二：AI 功能測試**

### **測試 2.1：Gemini API 連接**
```javascript
// 測試 AI 連接
function testAIConnection() {
  const result = testGeminiConnection();
  console.log('AI 連接測試結果:', result);
  
  // 預期結果：true (連接成功)
}
```

### **測試 2.2：語音記帳功能**
```javascript
// 測試語音記帳
function testVoiceAccounting() {
  try {
    const result = callGeminiForVoice('今天中午在麥當勞花了150元買午餐');
    console.log('語音記帳結果:', result);
    
    // 預期結果：包含結構化的交易資料 JSON
  } catch (error) {
    console.error('語音記帳測試失敗:', error.message);
  }
}
```

### **測試 2.3：郵件處理功能**
```javascript
// 測試郵件處理
function testEmailProcessing() {
  try {
    const result = callGeminiForEmailBody(
      '您好，您在7-11消費了89元，發票號碼AB12345678', 
      '消費通知'
    );
    console.log('郵件處理結果:', result);
    
    // 預期結果：包含結構化的交易資料 JSON
  } catch (error) {
    console.error('郵件處理測試失敗:', error.message);
  }
}
```

### **測試 2.4：IOU 代墊款功能**
```javascript
// 測試 IOU 功能
function testIOUFunction() {
  try {
    const result = callGeminiForIou('我幫大家墊了晚餐費用600元，要跟小明、小華、小美平分');
    console.log('IOU 處理結果:', result);
    
    // 預期結果：包含分帳資訊的 JSON
  } catch (error) {
    console.error('IOU 功能測試失敗:', error.message);
  }
}
```

## 🌐 **階段三：Web App 端點測試**

### **測試 3.1：部署 Web App**
1. 在 Google Apps Script 編輯器中點擊「部署」
2. 選擇「新增部署作業」
3. 類型選擇「網頁應用程式」
4. 執行身分：「我」
5. 存取權限：「任何人」
6. 點擊「部署」
7. 複製 Web App URL

### **測試 3.2：GET 端點測試**
使用瀏覽器或 Postman 測試：

```bash
# 語音記帳端點
GET https://your-web-app-url/exec?action=voice

# 圖片記帳端點  
GET https://your-web-app-url/exec?action=image

# PDF 處理端點
GET https://your-web-app-url/exec?action=pdf

# IOU 端點
GET https://your-web-app-url/exec?action=iou
```

預期結果：每個端點都應該返回相應的 HTML 表單頁面。

### **測試 3.3：POST 端點測試**
```bash
# 測試語音記帳 POST
curl -X POST "https://your-web-app-url/exec?action=voice" \
  -d "voiceText=今天買咖啡花了50元"

# 預期結果：返回處理後的 JSON 資料
```

## 📧 **階段四：郵件自動處理測試**

### **測試 4.1：郵件規則檢查**
```javascript
// 檢查郵件規則設定
function checkEmailRules() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.MAIN_LEDGER_ID);
    const rulesSheet = ss.getSheetByName(CONFIG.EMAIL_RULES_SHEET_NAME);
    
    if (rulesSheet) {
      const rules = rulesSheet.getDataRange().getValues();
      console.log('郵件規則數量:', rules.length - 1);
      console.log('規則內容:', rules);
    } else {
      console.log('❌ EmailRules 工作表不存在');
    }
  } catch (error) {
    console.error('郵件規則檢查失敗:', error.message);
  }
}
```

### **測試 4.2：安全郵件處理**
```javascript
// 測試安全郵件處理功能
function testSafeEmailProcessing() {
  const result = safeProcessAutomatedEmails();
  console.log('安全郵件處理結果:', result);
  
  // 檢查執行日誌，確認沒有錯誤
}
```

### **測試 4.3：財政部電子發票功能**
```javascript
// 測試財政部電子發票處理
function testMOFInvoice() {
  // 1. 修復規則
  const fixResult = fixMOFEmailRule();
  console.log('規則修復結果:', fixResult);
  
  // 2. 測試處理
  const testResult = testMOFEmailProcessing();
  console.log('處理測試結果:', testResult);
}
```

## 📊 **階段五：資料寫入測試**

### **測試 5.1：試算表寫入**
```javascript
// 測試資料寫入功能
function testSheetWriting() {
  try {
    const testData = {
      date: new Date().toLocaleDateString('zh-TW'),
      description: '測試記帳',
      amount: 100,
      category: '測試',
      source: 'manual_test'
    };
    
    const result = writeToSheet(testData, 'test');
    console.log('寫入結果:', result);
    
    // 檢查你的 Google Sheets，應該看到新增的測試資料
  } catch (error) {
    console.error('寫入測試失敗:', error.message);
  }
}
```

### **測試 5.2：IOU 帳本寫入**
```javascript
// 測試 IOU 帳本寫入
function testIOULedger() {
  try {
    const result = writeToIouLedger(
      '測試代墊款：晚餐費用300元，3人平分',
      300,
      '測試付款人',
      [
        { name: '人員A', amount: 100 },
        { name: '人員B', amount: 100 }
      ]
    );
    console.log('IOU 寫入結果:', result);
  } catch (error) {
    console.error('IOU 寫入測試失敗:', error.message);
  }
}
```

## 🔄 **階段六：完整系統測試**

### **測試 6.1：執行完整系統測試**
```javascript
// 執行完整的系統測試
function runCompleteSystemTest() {
  finalSystemTest();
  
  // 檢查執行日誌，應該看到：
  // ✅ 語音記帳測試成功
  // ✅ 郵件處理測試成功  
  // ✅ IOU 功能測試成功
  // ✅ 系統配置正常
  // ✅ 版本資訊正確
}
```

### **測試 6.2：觸發器測試**
```javascript
// 設定並測試觸發器
function setupTriggers() {
  // 刪除現有觸發器
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // 創建新觸發器 - 每5分鐘執行郵件處理
  ScriptApp.newTrigger('safeProcessAutomatedEmails')
    .timeBased()
    .everyMinutes(5)
    .create();
  
  // 創建新觸發器 - 每日系統健康檢查
  ScriptApp.newTrigger('checkSystemHealth')
    .timeBased()
    .everyDays(1)
    .atHour(9)
    .create();
  
  console.log('✅ 觸發器設定完成');
}
```

## 📱 **階段七：實際使用測試**

### **測試 7.1：語音記帳實測**
1. 使用 Web App URL 開啟語音記帳頁面
2. 輸入真實的消費記錄，例如：
   - "今天早上在星巴克買咖啡花了120元"
   - "昨天晚餐和朋友聚餐，我付了800元"
3. 提交後檢查 Google Sheets 是否正確記錄

### **測試 7.2：圖片記帳實測**
1. 使用 Web App URL 開啟圖片記帳頁面
2. 上傳一張收據或發票照片
3. 檢查 AI 是否正確識別並記錄交易資訊

### **測試 7.3：郵件自動處理實測**
1. 發送一封包含消費資訊的郵件到你的 Gmail
2. 等待觸發器執行（最多5分鐘）
3. 檢查 Google Sheets 是否自動記錄了郵件中的交易

## ✅ **測試結果檢查清單**

### **基礎功能**
- [ ] 版本資訊顯示 V49.5.0
- [ ] 系統健康檢查通過
- [ ] 系統診斷功能正常
- [ ] Gemini API 連接成功

### **AI 處理功能**
- [ ] 語音記帳 AI 處理正常
- [ ] 郵件處理 AI 分析正常
- [ ] IOU 代墊款 AI 計算正常

### **Web App 端點**
- [ ] 所有 GET 端點返回正確頁面
- [ ] 所有 POST 端點處理正常
- [ ] 錯誤處理機制正常

### **資料處理**
- [ ] Google Sheets 寫入正常
- [ ] IOU 帳本記錄正常
- [ ] 郵件自動處理正常
- [ ] 財政部電子發票處理正常

### **系統穩定性**
- [ ] 觸發器設定成功
- [ ] 錯誤處理機制正常
- [ ] 日誌記錄完整
- [ ] 性能表現良好

## 🚨 **常見問題排除**

### **API 連接問題**
```javascript
// 如果 Gemini API 測試失敗
function debugAPIConnection() {
  console.log('API Key 設定:', CONFIG.GEMINI_API_KEY ? '已設定' : '未設定');
  console.log('模型名稱:', CONFIG.GEMINI_MODEL_NAME);
  
  // 檢查 API 金鑰格式
  if (CONFIG.GEMINI_API_KEY && !CONFIG.GEMINI_API_KEY.startsWith('AIza')) {
    console.log('❌ API 金鑰格式可能不正確');
  }
}
```

### **試算表權限問題**
```javascript
// 如果試算表存取失敗
function debugSheetAccess() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.MAIN_LEDGER_ID);
    console.log('✅ 試算表存取正常:', ss.getName());
  } catch (error) {
    console.log('❌ 試算表存取失敗:', error.message);
    console.log('請檢查 MAIN_LEDGER_ID 是否正確');
  }
}
```

### **郵件權限問題**
```javascript
// 如果郵件存取失敗
function debugGmailAccess() {
  try {
    const threads = GmailApp.search('is:unread', 0, 1);
    console.log('✅ Gmail 存取正常，未讀郵件數:', threads.length);
  } catch (error) {
    console.log('❌ Gmail 存取失敗:', error.message);
    console.log('請確認已授權 Gmail 存取權限');
  }
}
```

## 🎯 **測試完成確認**

當所有測試都通過後，你的 V49.5.0 系統就完全準備好了！

### **成功指標**
- ✅ 所有基礎功能測試通過
- ✅ AI 處理功能正常運作
- ✅ Web App 端點響應正常
- ✅ 資料寫入和讀取正常
- ✅ 自動化功能正常運作

### **下一步**
1. 開始正常使用系統記帳
2. 定期執行 `checkSystemHealth()` 監控系統狀態
3. 根據需要調整觸發器頻率
4. 享受更穩定、更高效的智慧記帳體驗！

---

**🎉 恭喜！V49.5.0 精簡穩定版測試完成，系統已準備好為你提供優質的記帳服務！** 🚀