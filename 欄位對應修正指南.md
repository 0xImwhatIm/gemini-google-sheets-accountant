# ğŸ” è²¡æ”¿éƒ¨ CSV æ¬„ä½å°æ‡‰ä¿®æ­£æŒ‡å—

**å•é¡Œ**ï¼šè§£æåˆ° 0 å¼µç™¼ç¥¨ï¼Œæ¬„ä½è­˜åˆ¥å¤±æ•—  
**æ™‚é–“**ï¼š2025-08-04 11:06  
**åŸå› **ï¼šCSV æ¬„ä½çµæ§‹èˆ‡é æœŸä¸ç¬¦

---

## ğŸš¨ å•é¡Œè¨ºæ–·

### ç•¶å‰ç‹€æ³
```json
{
  "message": "âœ… æˆåŠŸè§£æ 0 å¼µç™¼ç¥¨",
  "message": "ğŸ“‹ è§£æåˆ° 0 å¼µç™¼ç¥¨"
}
```

### å¯èƒ½åŸå› 
1. **æ¬„ä½åç¨±ä¸åŒ¹é…**ï¼šCSV æ¨™é¡Œèˆ‡æˆ‘å€‘çš„è­˜åˆ¥é‚è¼¯ä¸ç¬¦
2. **åˆ†éš”ç¬¦å•é¡Œ**ï¼šå¯èƒ½ä¸æ˜¯é€—è™Ÿåˆ†éš”
3. **ç·¨ç¢¼å•é¡Œ**ï¼šä¸­æ–‡æ¬„ä½åç¨±äº‚ç¢¼
4. **è³‡æ–™æ ¼å¼å•é¡Œ**ï¼šé‡‘é¡æˆ–æ—¥æœŸæ ¼å¼ç•°å¸¸

---

## ğŸ”§ ç«‹å³è¨ºæ–·æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæª¢æŸ¥ CSV å¯¦éš›çµæ§‹
```javascript
// åŸ·è¡Œè©³ç´°çš„ CSV çµæ§‹åˆ†æ
debugCsvStructureDetailed()
```

### æ­¥é©Ÿ 2ï¼šæ‰‹å‹•æª¢æŸ¥æ¬„ä½æ˜ å°„
```javascript
// æª¢æŸ¥æ¬„ä½è­˜åˆ¥çµæœ
checkFieldMapping()
```

### æ­¥é©Ÿ 3ï¼šæ¸¬è©¦è³‡æ–™æå–
```javascript
// æ¸¬è©¦å–®è¡Œè³‡æ–™æå–
testSingleRowExtraction()
```

---

## ğŸ› ï¸ ä¿®æ­£å·¥å…·

è®“æˆ‘å»ºç«‹ä¸€å€‹è©³ç´°çš„è¨ºæ–·å·¥å…·ï¼š

```javascript
/**
 * ğŸ” è©³ç´°çš„ CSV çµæ§‹è¨ºæ–·
 */
function debugCsvStructureDetailed() {
  Logger.log('ğŸ” é–‹å§‹è©³ç´° CSV çµæ§‹è¨ºæ–·...');
  
  try {
    const threads = GmailApp.search('from:einvoice@einvoice.nat.gov.tw subject:å½™æ•´', 0, 1);
    
    if (threads.length === 0) {
      Logger.log('âŒ æ‰¾ä¸åˆ°è²¡æ”¿éƒ¨éƒµä»¶');
      return;
    }
    
    const message = threads[0].getMessages()[0];
    const attachments = message.getAttachments();
    
    for (let attachment of attachments) {
      const fileName = attachment.getName();
      
      if (fileName.toLowerCase().includes('.csv')) {
        Logger.log(`\nğŸ“Š è©³ç´°åˆ†æ CSV: ${fileName}`);
        
        // å˜—è©¦å¤šç¨®ç·¨ç¢¼
        let csvContent = null;
        const encodings = ['UTF-8', 'Big5', 'GBK'];
        
        for (let encoding of encodings) {
          try {
            csvContent = attachment.getDataAsString(encoding);
            Logger.log(`âœ… æˆåŠŸä½¿ç”¨ ${encoding} ç·¨ç¢¼`);
            break;
          } catch (error) {
            Logger.log(`âŒ ${encoding} ç·¨ç¢¼å¤±æ•—`);
          }
        }
        
        if (!csvContent) {
          Logger.log('âŒ æ‰€æœ‰ç·¨ç¢¼éƒ½å¤±æ•—');
          return;
        }
        
        // åˆ†æåˆ†éš”ç¬¦
        const firstLine = csvContent.split('\n')[0];
        Logger.log(`\nğŸ“‹ ç¬¬ä¸€è¡ŒåŸå§‹å…§å®¹:`);
        Logger.log(`"${firstLine}"`);
        
        const separators = [',', ';', '\t', '|'];
        separators.forEach(sep => {
          const columns = firstLine.split(sep);
          Logger.log(`\nåˆ†éš”ç¬¦ "${sep}": ${columns.length} å€‹æ¬„ä½`);
          columns.forEach((col, index) => {
            Logger.log(`  æ¬„ä½ ${index + 1}: "${col.trim()}"`);
          });
        });
        
        // åˆ†æå‰ 5 è¡Œè³‡æ–™
        const lines = csvContent.split('\n');
        Logger.log(`\nğŸ“Š å‰ 5 è¡Œè©³ç´°åˆ†æ:`);
        
        for (let i = 0; i < Math.min(5, lines.length); i++) {
          const line = lines[i].trim();
          if (line) {
            Logger.log(`\nè¡Œ ${i + 1}:`);
            Logger.log(`åŸå§‹: "${line}"`);
            
            const columns = line.split(',');
            Logger.log(`æ¬„ä½æ•¸: ${columns.length}`);
            
            columns.forEach((col, colIndex) => {
              const cleanCol = col.replace(/["\s]/g, '');
              Logger.log(`  [${colIndex + 1}] "${col.trim()}" -> "${cleanCol}"`);
              
              // æª¢æŸ¥æ˜¯å¦æ˜¯æ•¸å­—
              const numValue = parseFloat(cleanCol);
              if (!isNaN(numValue) && numValue > 0) {
                Logger.log(`    -> æ•¸å€¼: ${numValue}`);
              }
            });
          }
        }
      }
    }
    
  } catch (error) {
    Logger.log(`âŒ è©³ç´°è¨ºæ–·å¤±æ•—: ${error.toString()}`);
  }
}

/**
 * ğŸ¯ æª¢æŸ¥æ¬„ä½æ˜ å°„çµæœ
 */
function checkFieldMapping() {
  Logger.log('ğŸ¯ æª¢æŸ¥æ¬„ä½æ˜ å°„çµæœ...');
  
  try {
    const threads = GmailApp.search('from:einvoice@einvoice.nat.gov.tw subject:å½™æ•´', 0, 1);
    const message = threads[0].getMessages()[0];
    const attachments = message.getAttachments();
    
    for (let attachment of attachments) {
      const fileName = attachment.getName();
      
      if (fileName.toLowerCase().includes('.csv')) {
        const csvContent = attachment.getDataAsString('UTF-8');
        const lines = csvContent.split('\n');
        const headers = lines[0].split(',');
        
        Logger.log(`\nğŸ“‹ CSV æ¨™é¡Œè¡Œåˆ†æ:`);
        Logger.log(`ç¸½æ¬„ä½æ•¸: ${headers.length}`);
        
        headers.forEach((header, index) => {
          const cleanHeader = header.replace(/["\s]/g, '');
          Logger.log(`\næ¬„ä½ ${index + 1}: "${header.trim()}"`);
          Logger.log(`  æ¸…ç†å¾Œ: "${cleanHeader}"`);
          Logger.log(`  å°å¯«: "${cleanHeader.toLowerCase()}"`);
          
          // æª¢æŸ¥æ˜¯å¦åŒ¹é…æˆ‘å€‘çš„è­˜åˆ¥é‚è¼¯
          const matches = [];
          
          if (cleanHeader.toLowerCase().includes('æ—¥æœŸ') || 
              cleanHeader.toLowerCase().includes('date') || 
              cleanHeader.toLowerCase().includes('æ™‚é–“')) {
            matches.push('æ—¥æœŸæ¬„ä½');
          }
          
          if (cleanHeader.toLowerCase().includes('é‡‘é¡') || 
              cleanHeader.toLowerCase().includes('ç¸½è¨ˆ') || 
              cleanHeader.toLowerCase().includes('amount') || 
              cleanHeader.toLowerCase().includes('price')) {
            matches.push('é‡‘é¡æ¬„ä½');
          }
          
          if (cleanHeader.toLowerCase().includes('å•†å®¶') || 
              cleanHeader.toLowerCase().includes('åº—å®¶') || 
              cleanHeader.toLowerCase().includes('è³£æ–¹') || 
              cleanHeader.toLowerCase().includes('merchant')) {
            matches.push('å•†å®¶æ¬„ä½');
          }
          
          if (cleanHeader.toLowerCase().includes('ç™¼ç¥¨') || 
              cleanHeader.toLowerCase().includes('è™Ÿç¢¼') || 
              cleanHeader.toLowerCase().includes('invoice') || 
              cleanHeader.toLowerCase().includes('number')) {
            matches.push('ç™¼ç¥¨è™Ÿç¢¼æ¬„ä½');
          }
          
          if (matches.length > 0) {
            Logger.log(`  ğŸ¯ è­˜åˆ¥ç‚º: ${matches.join(', ')}`);
          } else {
            Logger.log(`  â“ æœªè­˜åˆ¥`);
          }
        });
        
        // æ¸¬è©¦ç¬¬äºŒè¡Œè³‡æ–™
        if (lines.length > 1) {
          Logger.log(`\nğŸ“Š ç¬¬äºŒè¡Œè³‡æ–™æ¸¬è©¦:`);
          const dataRow = lines[1].split(',');
          
          dataRow.forEach((cell, index) => {
            const cleanCell = cell.replace(/["\s]/g, '');
            Logger.log(`  [${index + 1}] "${cell.trim()}" -> "${cleanCell}"`);
            
            const numValue = parseFloat(cleanCell);
            if (!isNaN(numValue) && numValue > 0) {
              if (numValue >= 1 && numValue <= 100000) {
                Logger.log(`    -> å¯èƒ½æ˜¯é‡‘é¡: ${numValue}`);
              } else {
                Logger.log(`    -> æ•¸å€¼éå¤§ï¼Œå¯èƒ½æ˜¯ID: ${numValue}`);
              }
            }
          });
        }
      }
    }
    
  } catch (error) {
    Logger.log(`âŒ æ¬„ä½æ˜ å°„æª¢æŸ¥å¤±æ•—: ${error.toString()}`);
  }
}

/**
 * ğŸ§ª æ¸¬è©¦å–®è¡Œè³‡æ–™æå–
 */
function testSingleRowExtraction() {
  Logger.log('ğŸ§ª æ¸¬è©¦å–®è¡Œè³‡æ–™æå–...');
  
  try {
    const threads = GmailApp.search('from:einvoice@einvoice.nat.gov.tw subject:å½™æ•´', 0, 1);
    const message = threads[0].getMessages()[0];
    const attachments = message.getAttachments();
    
    for (let attachment of attachments) {
      const fileName = attachment.getName();
      
      if (fileName.toLowerCase().includes('.csv')) {
        const csvContent = attachment.getDataAsString('UTF-8');
        const lines = csvContent.split('\n');
        
        if (lines.length > 1) {
          Logger.log(`\nğŸ§ª æ¸¬è©¦ç¬¬äºŒè¡Œè³‡æ–™æå–:`);
          
          const headers = lines[0].split(',');
          const dataRow = lines[1].split(',');
          
          Logger.log(`æ¨™é¡Œè¡Œ: ${headers.length} å€‹æ¬„ä½`);
          Logger.log(`è³‡æ–™è¡Œ: ${dataRow.length} å€‹æ¬„ä½`);
          
          // å˜—è©¦æ‰‹å‹•æå–
          let extractedData = {
            date: '',
            amount: 0,
            merchant: '',
            invoiceNumber: ''
          };
          
          // é€æ¬„ä½åˆ†æ
          for (let i = 0; i < Math.min(headers.length, dataRow.length); i++) {
            const header = headers[i].replace(/["\s]/g, '').toLowerCase();
            const data = dataRow[i].replace(/["\s]/g, '');
            
            Logger.log(`\næ¬„ä½ ${i + 1}:`);
            Logger.log(`  æ¨™é¡Œ: "${headers[i].trim()}"`);
            Logger.log(`  è³‡æ–™: "${dataRow[i].trim()}"`);
            
            // å˜—è©¦è­˜åˆ¥å’Œæå–
            if (header.includes('æ—¥æœŸ') || header.includes('date')) {
              extractedData.date = data;
              Logger.log(`  -> è­˜åˆ¥ç‚ºæ—¥æœŸ: ${data}`);
            }
            
            const numValue = parseFloat(data);
            if (!isNaN(numValue) && numValue >= 1 && numValue <= 100000) {
              if (extractedData.amount === 0 || numValue > extractedData.amount) {
                extractedData.amount = numValue;
                Logger.log(`  -> è­˜åˆ¥ç‚ºé‡‘é¡: ${numValue}`);
              }
            }
            
            if (header.includes('å•†å®¶') || header.includes('åº—å®¶') || header.includes('merchant')) {
              extractedData.merchant = data;
              Logger.log(`  -> è­˜åˆ¥ç‚ºå•†å®¶: ${data}`);
            }
            
            if (header.includes('ç™¼ç¥¨') || header.includes('invoice')) {
              extractedData.invoiceNumber = data;
              Logger.log(`  -> è­˜åˆ¥ç‚ºç™¼ç¥¨è™Ÿç¢¼: ${data}`);
            }
          }
          
          Logger.log(`\nğŸ“Š æå–çµæœ:`);
          Logger.log(`  æ—¥æœŸ: "${extractedData.date}"`);
          Logger.log(`  é‡‘é¡: ${extractedData.amount}`);
          Logger.log(`  å•†å®¶: "${extractedData.merchant}"`);
          Logger.log(`  ç™¼ç¥¨è™Ÿç¢¼: "${extractedData.invoiceNumber}"`);
          
          if (extractedData.amount > 0) {
            Logger.log(`âœ… æˆåŠŸæå–åˆ°æœ‰æ•ˆè³‡æ–™ï¼`);
          } else {
            Logger.log(`âŒ æœªèƒ½æå–åˆ°æœ‰æ•ˆé‡‘é¡`);
          }
        }
      }
    }
    
  } catch (error) {
    Logger.log(`âŒ å–®è¡Œæå–æ¸¬è©¦å¤±æ•—: ${error.toString()}`);
  }
}
```

---

## ğŸš€ åŸ·è¡Œè¨ºæ–·

è«‹æŒ‰é †åºåŸ·è¡Œä»¥ä¸‹å‡½æ•¸ï¼š

```javascript
// 1. è©³ç´°çµæ§‹è¨ºæ–·
debugCsvStructureDetailed()

// 2. æª¢æŸ¥æ¬„ä½æ˜ å°„
checkFieldMapping()

// 3. æ¸¬è©¦å–®è¡Œæå–
testSingleRowExtraction()
```

---

## ğŸ“Š é æœŸçµæœ

è¨ºæ–·å®Œæˆå¾Œï¼Œæˆ‘å€‘æœƒçœ‹åˆ°ï¼š
- ğŸ“‹ CSV çš„å¯¦éš›æ¬„ä½åç¨±
- ğŸ¯ å“ªäº›æ¬„ä½è¢«æ­£ç¢ºè­˜åˆ¥
- ğŸ’° é‡‘é¡è³‡æ–™åœ¨å“ªå€‹æ¬„ä½
- ğŸ“… æ—¥æœŸæ ¼å¼æ˜¯ä»€éº¼æ¨£çš„
- ğŸª å•†å®¶è³‡è¨Šçš„ä½ç½®

æ ¹æ“šè¨ºæ–·çµæœï¼Œæˆ‘å€‘å°±èƒ½ä¿®æ­£æ¬„ä½è­˜åˆ¥é‚è¼¯ï¼Œè®“æ¯å¼µç™¼ç¥¨éƒ½èƒ½æ­£ç¢ºè§£æï¼

---

**è¨ºæ–·æŒ‡å—å»ºç«‹æ™‚é–“**ï¼š2025-08-04 11:10  
**ç›®æ¨™**ï¼šæ‰¾å‡º CSV æ¬„ä½çµæ§‹ï¼Œä¿®æ­£è§£æé‚è¼¯