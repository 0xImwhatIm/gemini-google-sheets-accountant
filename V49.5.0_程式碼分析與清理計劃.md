# V49.5.0 程式碼分析與清理計劃

## 📊 **程式碼結構分析**

### **核心功能模組 (必須保留)**

#### **1. 基礎設定與配置**
- ✅ `CONFIG` 物件 - 系統配置
- ✅ `safeExecute()` - 錯誤處理包裝
- ✅ 配置初始化檢查

#### **2. Web App 路由 (核心)**
- ✅ `doGet()` - GET 請求處理
- ✅ `doPost()` - POST 請求處理
- ✅ `doGet_Voice()`, `doPost_Voice()` - 語音端點
- ✅ `doGet_Image()`, `doPost_Image()` - 圖片端點
- ✅ `doGet_Pdf()`, `doPost_Pdf()` - PDF 端點
- ✅ `doGet_Iou()`, `doPost_Iou()` - IOU 端點

#### **3. 時區與日期處理 (核心)**
- ✅ `getCurrentTimezoneDateTime()` - 時區感知日期
- ✅ `getRelativeTimezoneDate()` - 相對日期計算
- ✅ `generatePromptDateInfo()` - 日期資訊生成

#### **4. AI Prompt 生成 (核心)**
- ✅ `generateVoicePromptWithDynamicDate()` - 語音 Prompt
- ✅ `generateImagePromptWithDynamicDate()` - 圖片 Prompt
- ✅ `extractJsonFromText()` - JSON 解析

#### **5. Gemini API 調用 (核心)**
- ✅ `callGeminiForVoice()` - 語音處理
- ✅ `callGeminiForVision()` - 圖片處理
- ✅ `callGeminiForEmailBody()` - 郵件處理
- ✅ `callGeminiForPdf()` - PDF 處理
- ✅ `callGeminiForIou()` - IOU 處理

#### **6. 資料寫入與處理 (核心)**
- ✅ `writeToSheet()` - 試算表寫入
- ✅ `getExchangeRate()` - 匯率轉換
- ✅ `processAutomatedEmails()` - 郵件自動處理

#### **7. IOU 代墊款功能 (核心)**
- ✅ `handleGroupSplit()` - 群組分帳
- ✅ `handleSettlement()` - 結算處理
- ✅ `writeToIouLedger()` - IOU 記錄

#### **8. 財政部電子發票 (核心)**
- ✅ `setupMOFInvoiceRule()` - 規則設定
- ✅ `processMOFInvoiceCSV()` - CSV 處理

#### **9. 系統資訊 (核心)**
- ✅ `getVersionInfo()` - 版本資訊
- ✅ `checkSystemHealth()` - 系統健康檢查

### **測試與診斷功能 (需要清理)**

#### **🔍 保留的測試函數 (精簡版)**
- ✅ `testGeminiConnection()` - API 連接測試
- ✅ `testMOFInvoiceSetup()` - 財政部設定測試
- ✅ `markMOFEmailUnreadAndTest()` - 財政部郵件測試

#### **🗑️ 可以刪除的重複測試函數**
- ❌ `listAvailableModels()` - 重複功能
- ❌ `testSingleModel()` - 過於詳細
- ❌ `testJsonMode()` - 不必要
- ❌ `finalSystemTestV49_4_2()` - 版本特定
- ❌ `diagnoseMOFEmailMatching()` - 重複診斷
- ❌ `testMOFCSVFormat()` - 重複測試
- ❌ `testRealMOFEmailAttachment()` - 重複功能
- ❌ `findMOFInvoiceEmails()` - 重複搜尋
- ❌ `completeMOFInvoiceDiagnosis()` - 過於複雜
- ❌ `comprehensiveEmailSearch()` - 重複搜尋
- ❌ `diagnoseRealCSVFormat()` - 重複診斷
- ❌ `manualEmailCheck()` - 只是指南
- ❌ `testEmailRuleMatching()` - 重複測試
- ❌ `testFixedMOFProcessing()` - 重複測試
- ❌ `simpleCSVDiagnosis()` - 重複診斷

#### **🔧 最近新增的診斷函數 (保留簡化版)**
- ✅ `diagnoseReferenceError()` - 系統診斷 (簡化)
- ✅ `safeProcessAutomatedEmails()` - 安全執行
- ✅ `fixMOFEmailRule()` - 規則修復
- ✅ `testFixedMOFEmailProcessing()` - 完整測試

### **重複的修正版本函數 (需要清理)**
- ❌ `markMOFEmailUnreadAndTestFixed()` - 重複
- ❌ `markMOFEmailUnreadAndTestCorrected()` - 重複
- ❌ `quickFixMOFInvoice()` - 保留原版
- ❌ `quickFixMOFInvoiceCorrected()` - 重複

## 🎯 **清理策略**

### **第一階段：刪除重複函數**
1. 刪除所有 `*Fixed()`, `*Corrected()` 版本的函數
2. 保留原始版本的函數
3. 刪除過於詳細的測試函數

### **第二階段：簡化診斷函數**
1. 合併相似的診斷功能
2. 保留最實用的測試函數
3. 刪除版本特定的測試

### **第三階段：更新版本資訊**
1. 更新到 V49.5.0
2. 更新所有版本相關的字符串
3. 更新功能描述

## 📋 **預期清理結果**

### **清理前**
- 📊 **總函數數量**: ~60+ 個
- 🔍 **測試函數**: ~30+ 個
- 📁 **重複函數**: ~15+ 個

### **清理後**
- 📊 **總函數數量**: ~35 個
- 🔍 **測試函數**: ~8 個
- 📁 **重複函數**: 0 個

### **保留的核心功能**
- ✅ **Web App 端點**: 完整保留
- ✅ **AI 處理**: 完整保留
- ✅ **郵件自動處理**: 完整保留
- ✅ **財政部電子發票**: 完整保留
- ✅ **IOU 代墊款**: 完整保留
- ✅ **基礎測試**: 精簡保留

## 🚀 **執行計劃**

### **步驟 1: 版本更新**
- 更新版本號到 V49.5.0
- 更新版本描述和日期

### **步驟 2: 刪除重複函數**
- 刪除所有重複的修正版本函數
- 保留原始版本

### **步驟 3: 清理測試函數**
- 刪除過於詳細的測試函數
- 保留核心測試功能

### **步驟 4: 最終驗證**
- 語法檢查
- 功能測試
- 文檔更新

## ✅ **清理原則**

1. **保留核心業務邏輯**
2. **刪除重複和冗餘功能**
3. **簡化測試和診斷**
4. **維持系統穩定性**
5. **提高代碼可維護性**