# 🚀 V47.5 部署指南

## 📋 部署概述

V47.5 是一個重要的配置修復版本，採用漸進式重構策略，解決了 V47.4.3 中的配置系統混亂和 404 錯誤問題。

## ⚠️ 部署前準備

### **1. 備份確認**
✅ 當前版本已自動備份為 `Code_V47.4.3_BACKUP.gs`

### **2. 配置準備**
準備以下信息：
- 📄 **Google Sheet ID**：你的記帳表格 ID
- 🔑 **Gemini API Key**：你的 Gemini API 金鑰

### **3. 測試環境**
建議先在測試環境部署，確認無誤後再部署到生產環境。

## 🔧 配置設定步驟

### **步驟 1：設定指令碼屬性**

1. 在 Google Apps Script 編輯器中
2. 點擊左側的「專案設定」⚙️
3. 滾動到「指令碼屬性」區域
4. 點擊「新增指令碼屬性」

### **步驟 2：添加必要配置**

添加以下屬性：

| 屬性名稱 | 值 | 說明 |
|----------|----|----|
| `MAIN_LEDGER_ID` | `你的Google Sheet ID` | 主記帳表格的 ID |
| `GEMINI_API_KEY` | `你的Gemini API金鑰` | Gemini API 的存取金鑰 |

**如何獲取 Google Sheet ID：**
```
https://docs.google.com/spreadsheets/d/1ABC123DEF456GHI789JKL/edit
                                    ↑這部分就是 Sheet ID↑
```

### **步驟 3：可選配置**

如果你使用 Google Drive 功能，也可以添加：

| 屬性名稱 | 值 | 說明 |
|----------|----|----|
| `FOLDER_ID_TO_PROCESS` | `資料夾ID` | 待處理文件資料夾 |
| `FOLDER_ID_ARCHIVE` | `資料夾ID` | 歸檔資料夾 |
| `FOLDER_ID_DUPLICATES` | `資料夾ID` | 重複文件資料夾 |

## 🚀 部署步驟

### **步驟 1：保存代碼**
1. 確認 `Code.gs` 包含 V47.5 的完整代碼
2. 按 `Ctrl+S` (Windows) 或 `Cmd+S` (Mac) 保存

### **步驟 2：部署新版本**
1. 點擊右上角的「部署」按鈕
2. 選擇「管理部署」
3. 點擊現有部署旁的「編輯」圖標 ✏️
4. 在「版本」下拉選單中選擇「新版本」
5. 在「說明」中輸入：`V47.5.0 - 配置修復版本`
6. 點擊「部署」

### **步驟 3：記錄部署 URL**
複製新的部署 URL，格式類似：
```
https://script.google.com/macros/s/AKfyc...../exec
```

## ✅ 部署驗證

### **1. 配置診斷測試**
訪問診斷端點：
```
https://your-deployment-url/exec?endpoint=test
```

**預期回應：**
```json
{
  "status": "success",
  "version": "V47.5.0",
  "message": "配置修復版本正常運行",
  "config": {
    "hasMainLedgerId": true,
    "hasGeminiApiKey": true,
    "timezone": "Asia/Taipei"
  }
}
```

### **2. 執行配置測試函數**
在 GAS 編輯器中執行：
```javascript
testV47_5_Configuration()
```

**預期日誌輸出：**
```
✅ V47.5 配置檢查通過
✅ 配置驗證通過
✅ 當前日期: 2025-08-07
✅ Google Sheets 連接成功
```

### **3. 執行圖片處理測試**
在 GAS 編輯器中執行：
```javascript
testV47_5_ImageProcessing()
```

**預期日誌輸出：**
```
[V47.5-Vision] 使用 API 端點: gemini-1.5-flash-latest
[V47.5-Vision] API 回應狀態: 200
✅ V47.5 圖片處理測試成功
```

## 📱 iOS 捷徑更新

### **如果創建了新部署**
1. 打開 iOS 捷徑應用
2. 找到拍照記帳的捷徑
3. 編輯捷徑中的 URL
4. 更新為新的部署 URL

### **如果更新了現有部署**
iOS 捷徑無需修改，會自動使用新版本。

## 🔍 故障排除

### **問題 1：配置錯誤**
**症狀：** 診斷端點顯示配置未設定
**解決：**
1. 檢查「指令碼屬性」中的設定
2. 確認屬性名稱拼寫正確
3. 確認屬性值沒有多餘空格

### **問題 2：仍然出現 404 錯誤**
**症狀：** iOS 捷徑調用仍然失敗
**解決：**
1. 確認已選擇「新版本」部署
2. 等待 2-3 分鐘讓部署完全生效
3. 清除 iOS 捷徑快取（重新運行一次）

### **問題 3：Google Sheets 連接失敗**
**症狀：** 無法寫入記帳資料
**解決：**
1. 檢查 `MAIN_LEDGER_ID` 是否正確
2. 確認 Google Sheet 的共享權限
3. 確認工作表名稱為 "All Records"

### **問題 4：Gemini API 調用失敗**
**症狀：** AI 處理失敗
**解決：**
1. 檢查 `GEMINI_API_KEY` 是否正確
2. 確認 API 金鑰有足夠的配額
3. 檢查 Google Cloud Console 中的 API 設定

## 🔄 回滾程序

如果 V47.5 出現問題，可以快速回滾：

### **步驟 1：恢復代碼**
1. 打開 `Code_V47.4.3_BACKUP.gs`
2. 複製全部內容
3. 貼上到 `Code.gs` 中
4. 保存

### **步驟 2：重新部署**
1. 點擊「部署」→「管理部署」
2. 選擇「新版本」
3. 說明：`回滾到 V47.4.3`
4. 部署

## 📊 部署檢查清單

- [ ] **配置設定完成**
  - [ ] MAIN_LEDGER_ID 已設定
  - [ ] GEMINI_API_KEY 已設定
- [ ] **代碼部署完成**
  - [ ] Code.gs 包含 V47.5 代碼
  - [ ] 選擇「新版本」部署
  - [ ] 部署成功完成
- [ ] **功能驗證完成**
  - [ ] 診斷端點測試通過
  - [ ] 配置測試函數通過
  - [ ] 圖片處理測試通過
- [ ] **iOS 捷徑測試**
  - [ ] 語音記帳功能正常
  - [ ] 拍照記帳功能正常
  - [ ] 不再出現 404 錯誤

## 🎉 部署完成

恭喜！V47.5 部署完成。你現在擁有：

✅ **更穩定的配置系統**
✅ **修復的 404 錯誤**
✅ **簡化的錯誤處理**
✅ **完整的功能保留**
✅ **更好的診斷工具**

如有任何問題，請參考故障排除部分或查看執行記錄中的詳細錯誤信息。